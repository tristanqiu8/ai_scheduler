# Launch Strategies Overview

本文面向开发者，总结 AI Scheduler 目前支持的发射策略，以及各策略的适用场景、核心实现逻辑、现存限制和潜在改进方向。若后续扩展新策略或调整算法，请同步维护此文档。

## Eager
- **定位**：尽早发射所有任务，强调响应速度。
- **关键流程**：
  - 按拓扑顺序（同时考虑优先级）遍历任务，基于 `min_interval` 推导实例序列。
  - 通过 `_calculate_launch_time_with_dependencies` 校正发射时刻，确保依赖完成。
  - 缓存 `(task, instance)` 的发射时间与完成时间，减少递归重复计算。
- **特性**：
  - 支持 `launch_profile` 的固定偏移；未设置的任务维持急切策略。
  - 依赖缓冲 `guard_ms` 按依赖任务执行时长的 10% 自适应（范围 0.2–3 ms），减少高 FPS 场景的冗余等待。
- **局限与改进**：
  - 当前未纳入实时资源拥塞；后续可引入队列长度或历史 idle 时间做轻量预测。
  - 缓冲比例为经验值，可考虑开放配置，或按资源类型调整权重。

## Balanced
- **定位**：在满足依赖的前提下，实现同优先级内的均衡调度。
- **关键流程**：
  - 先按优先级分组，再在组内依据拓扑排序保持生产者先行。
  - 以组内最小 `min_interval` 为参考，计算动态 offset（`max(1 ms, min(min_interval × 0.5, 10 ms))`）。
  - `launch_profile` 可覆盖默认 offset；若未尊重依赖，则直接使用外部偏移。
- **特性**：
  - 避免固定 5 ms 偏移在混合 FPS 场景下失效。
  - 仍保留依赖校正逻辑，保障消费者任务在供应方完成后再发射。
- **局限与改进**：
  - 动态 offset 仅基于 `min_interval`，后续可叠加优先级或段时长权重。
  - 组内每次重新过滤拓扑序列，未来可缓存以降低大图开销。
  - 可探索结合资源利用率反馈（如最近平均等待时间）调节 offset。

## Lazy
- **定位**：尽量延后发射任务，为资源让出空间。
- **关键流程**：
  - 对单实例任务，将发射时间推至窗口末尾（预留执行裕度）。
  - 对多实例任务，从窗口后端逆序计算发射点，随后再调用依赖校正。
- **局限与改进**：
  - 主要用于低负载场景，尚无针对高并发、硬约束场景的额外优化。
  - 可考虑融合 Balanced 的动态 offset、或与 slack/jitter 结合以避免阻塞。

## Sync
- **定位**：面向 ISP 管线，强制按 ISP 段顺序轮转发射。
- **关键流程**：
  - 找出每个任务的 ISP 段，按段时长叠加生成同步偏移。
  - 以 ISP 总时长为周期，循环发射任务；后续段利用 `min_interval` 限制。
- **特性**：
  - 适用于必须严格排成流水线的视觉 ISP 场景。
  - 禁用随机扰动，偏移完全由算法推导。
- **局限与改进**：
  - 仅适用于存在 ISP 段的任务，若场景含异构资源可能需自定义策略。
  - 可探索在 ISP 轮转外引入 NPU/DSP 的次级错峰逻辑。

## Fixed
- **定位**：显式指定每个任务的发射相位，适合需要精确对齐的场景。
- **关键流程**：
  - `launch_profile.offset_ms` 定义初始偏移，并按 `min_interval` 周期性重复发射。
  - 如果 `respect_dependencies=True`，仍会通过依赖校正调整发射时刻。
- **特性**：
  - 支持随机 slack（除非配置关闭），增强对实际 jitter 的模拟。
  - 结合 `launch_profile` 可实现多任务严格相位控制。
- **局限与改进**：
  - 目前未检测显式偏移与依赖冲突，除非开启 respect_dependencies。
  - 可考虑增加对资源拥塞的动态反馈，例如自动微调实例间距。

## 通用改进方向
- **依赖缓存**：当前发射与完成时间缓存的键为 `(task_id, instance_id)`，未来可纳入 `time_window` 或策略名称，以避免跨窗口调度误用。
- **配置灵活度**：对关键参数（依赖缓冲比例、offset clamp 上限）提供配置入口，方便调优与 A/B 测试。
- **指标可视化**：结合 `ScheduleTracer` 输出每个策略的发射/执行统计，有助于分析优化效果。
- **资源感知**：无论哪种策略，若能读取队列状态（排队长度、平均等待时间）并反馈到发射时刻，会显著提升动态场景的稳定性。

> 若未来添加新策略或大幅改动逻辑，请在此文档补充“策略概述”、“核心流程”、“当前局限与规划”，便于持续维护。
